steps:

- name: gcr.io/cloud-builders/git
  args: ['clone', 'https://github.com/dgageot/skaffold-ci.git']

# Can we retrieve from fork's branch?
- name: gcr.io/cloud-builders/git
  dir: skaffold-ci
  args: ['reset', '--hard', '$COMMIT_SHA']

- name: gcr.io/cloud-builders/docker
  args: ['pull', 'golang:1.11.5-stretch']

- name: golang:1.11.5-stretch
  entrypoint: /bin/bash
  args:
  - -c
  - |
    PARENT_DIR="$$GOPATH/src/github.com/GoogleContainerTools"
    mkdir -p $$PARENT_DIR
    ln -s /workspace/skaffold-ci $$PARENT_DIR/skaffold
    cd $$PARENT_DIR/skaffold

    make out/skaffold test

- name: golang:1.11.5-stretch
  entrypoint: /bin/bash
  env:
  - REMOTE_INTEGRATION=true
  - GCP_PROJECT=$PROJECT_ID
  - GKE_CLUSTER_NAME=skaffold-ci
  - GKE_ZONE=us-central1-f
  args:
  - -c
  - |
    PARENT_DIR="$$GOPATH/src/github.com/GoogleContainerTools"
    mkdir -p $$PARENT_DIR
    ln -s /workspace/skaffold-ci $$PARENT_DIR/skaffold
    cd $$PARENT_DIR/skaffold

    make integration